<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Stream</title>
    <!-- Updated icon with new color palette -->
    <link rel="icon" type="image/x-icon" href="images/G-icon.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script type='text/javascript' src='//candyaversion.com/98/78/12/9878125c00c51d2fe29f4bb8c227f1fc.js'></script>
    <style>
        /* Custom styles with the Netflix color palette */
        body {
            background-color: #141414; /* Netflix Dark Background */
            font-family: 'Inter', sans-serif;
            color: #F9FAFB; /* Off-white */
        }

        /* Hides the scrollbar but allows scrolling in movie rows */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Creates the fade-out effect at the bottom of the banner */
        .banner-fade-bottom {
            height: 6.4rem;
            /* Updated gradient to match new dark background */
            background-image: linear-gradient(180deg, transparent, rgba(20, 20, 20, .61), #141414);
        }

        /* Ensures the video player maintains a 16:9 aspect ratio */
        #modal-video-container {
            aspect-ratio: 16 / 9;
        }

        /* Styles for the scroll arrows on movie rows */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(20, 20, 20, 0.5); /* Dark background with alpha */
            color: #F9FAFB; /* Light text */
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            border-radius: 9999px; /* fully rounded */
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .row-container:hover .scroll-arrow {
            opacity: 1;
        }

        .scroll-arrow.left {
            left: 0.5rem;
        }

        .scroll-arrow.right {
            right: 0.5rem;
        }

        /* Custom scrollbar for a cleaner look on dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #141414; /* Darkest */
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; /* Mid-dark */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563; /* Mid-light */
        }

        .poster-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .poster-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }
        
        .sort-button, .filter-button {
            padding: 8px 16px;
            border-radius: 9999px; /* full rounded */
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        /* Active buttons use red accent */
        .sort-button.active {
            background-color: #E50914; /* Netflix Red */
            color: #F9FAFB; /* Off-white text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .filter-button.active {
            background-color: #6B7280; /* Gray-500 */
            color: #F9FAFB; /* Off-white text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Inactive buttons */
        .sort-button:not(.active), .filter-button:not(.active) {
            background-color: #374151; /* Gray-700 */
            color: #9CA3AF; /* Gray-400 text */
        }
        .sort-button:not(.active):hover, .filter-button:not(.active):hover {
            background-color: #4B5563; /* Gray-600 */
            color: #F9FAFB; /* Off-white text */
        }

        /* New styles for stream source switcher buttons */
        .stream-source-button {
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 0.5rem;
        }
        .active-source-button {
            outline: none;
            background-color: #E50914; /* Netflix Red */
            color: #F9FAFB; /* Off-white text */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .inactive-source-button {
            background-color: #374151; /* Gray-700 */
            color: #9CA3AF; /* Gray-400 */
        }
        .inactive-source-button:hover {
            background-color: #4B5563; /* Gray-600 */
            color: #F9FAFB; /* Off-white */
        }
        .vline {
            background-color: #E50914; /* Netflix Red accent */
            padding-right: 5px;
            margin-right: 5px;
        }
         .nav-link.active {
            color: #E50914; /* Netflix Red */
            border-bottom-color: #E50914; /* Netflix Red */
        }
    </style>
</head>
<body class="text-[#F9FAFB]"> <!-- Base text color -->

    <!-- Navbar: Stays at the top -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 p-4 transition-colors duration-500 bg-transparent">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <a href="#" class="text-2xl md:text-3xl font-extrabold text-[#E50914] no-underline hover:opacity-80 transition" onclick="showMainContent()">
                GOSTREAM</a>
            <div class="flex items-center space-x-8">
                <!-- Updated icon -->
                <!-- <img class="rounded-full h-8 w-8" src="https://placehold.co/32x32/E50914/FFFFFF?text=G" alt="Profile Avatar"> -->
                <!-- Updated logo text color -->
                
                 <nav id="desktop-nav" class="hidden sm:flex space-x-6 text-lg">
                    <!-- Updated nav link hover color -->
                    <a href="#" onclick="navigateTo('popular-movies-section', 1)" class="hover:text-[#F87171] transition duration-200 font-medium nav-link border-b-2 border-transparent" data-section-id="popular-movies-section">Movies</a>
                    <a href="#" onclick="navigateTo('popular-tv-section', 1)" class="hover:text-[#F87171] transition duration-200 font-medium nav-link border-b-2 border-transparent" data-section-id="popular-tv-section">TV Shows</a>
                    <a href="#" onclick="navigateTo('korean-tv-section', 1)" class="hover:text-[#F87171] transition duration-200 font-medium nav-link border-b-2 border-transparent" data-section-id="korean-tv-section">K-Drama</a>
                    <a href="#" onclick="navigateTo('anime-section', 1)" class="hover:text-[#F87171] transition duration-200 font-medium nav-link border-b-2 border-transparent" data-section-id="anime-section">Anime</a>
                </nav>
            </div>
             <div class="flex items-center space-x-4">
                <div class="relative hidden sm:block">
                    <!-- Updated search input style -->
                    <input
                        type="text"
                        id="search-input-desktop"
                        placeholder="Search..."
                        class="w-full py-2 pl-4 pr-10 bg-[#1F2937] text-[#F9FAFB] rounded-full focus:ring-2 focus:ring-[#E50914] focus:outline-none placeholder-[#9CA3AF] transition duration-200"
                        onkeydown="if(event.key === 'Enter') handleSearchDesktop()"
                    >
                    <button
                        onclick="handleSearchDesktop()"
                        class="absolute right-0 top-0 mt-2 mr-3 text-[#9CA3AF] hover:text-[#F9FAFB] transition duration-200"
                    ></button>
                </div>
                <!-- Mobile Icons -->
                <div class="sm:hidden flex items-center">
                     <button id="mobile-search-toggle" class="text-[#F9FAFB] p-2 rounded-full hover:bg-[#1F2937] transition" onclick="toggleMobileSearchOverlay()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                    <button id="mobile-menu-button" class="text-[#F9FAFB] p-2 rounded-full hover:bg-[#1F2937] transition" onclick="toggleMobileNav()">
                        <svg id="menu-open-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <svg id="menu-close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Nav Menu -->
  <div id="mobile-nav" class="sm:hidden fixed pt-10 w-full h-full z-40 transform -translate-x-full transition-transform duration-300 ease-in-out bg-black bg-opacity-80">
    <ul class="flex flex-col p-2 md:p-0 text-center mt-8 font-medium rounded-lg md:space-x-8 rtl:space-x-reverse md:flex-row">
      <li>
        <a href="#" class="block py-2 px-3 text-[#F9FAFB] rounded-sm hover:bg-[#E50914] hover:text-[#F9FAFB]" onclick="navigateTo('popular-movies-section', 1); toggleMobileNav();">Movies</a>
      <li>
        <a href="#" class="block py-2 px-3 text-[#F9FAFB] rounded-sm hover:bg-[#E50914] hover:text-[#F9FAFB]" onclick="navigateTo('popular-tv-section', 1); toggleMobileNav();">TV Shows</a>
      </li>
      <li>
        <a href="#" class="block py-2 px-3 text-[#F9FAFB] rounded-sm hover:bg-[#E50914] hover:text-[#F9FAFB]" onclick="navigateTo('korean-tv-section', 1); toggleMobileNav();">K-Drama</a>
      </li>
      <li>
        <a href="#" class="block py-2 px-3 text-[#F9FAFB] rounded-sm hover:bg-[#E50914] hover:text-[#F9FAFB]" onclick="navigateTo('anime-section', 1); toggleMobileNav();">Anime</a>
      </li>
    </ul>
  </div>
    
    <!-- Mobile Search Overlay -->
    <div id="mobile-search-filter-overlay" class="lg:hidden fixed top-0 left-0 right-0 bg-black z-40 p-4 transition-transform duration-300 transform -translate-y-full">
        <div class="relative mt-16">
            <input type="text" id="search-input-mobile" placeholder="Search for movies, TV shows..." class="w-full py-2 pl-4 pr-10 bg-[#1F2937] text-[#F9FAFB] rounded-full focus:ring-2 focus:ring-[#E50914] focus:outline-none placeholder-[#9CA3AF]" onkeydown="if(event.key === 'Enter') handleSearchMobile()">
            <button onclick="handleSearchMobile()" class="absolute right-0 top-0 mt-2 mr-3 text-[#9CA3AF] hover:text-[#F9FAFB]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
        </div>
    </div>


    <div id="main-content">
        <!-- Banner Section: The big featured movie at the top -->
        <header id="banner" class="relative text-[#F9FAFB] object-cover bg-cover bg-center" style="height: 70vw; max-height: 600px;">
            <div class="absolute inset-0 bg-[#141414] bg-opacity-70 flex items-center justify-center hidden" id="banner-loading">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-[#F9FAFB]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="pt-20 xs:pt-15 sm:pt-40 md:pt-48 lg:pt-56 px-4 sm:px-8 h-full">
                <h1 id="banner-title" class="flex text-3xl sm:text-5xl md:text-6xl font-extrabold"></h1>
                <div class="flex my-2">
                    <button id="banner-play-btn" class="flex bg-[#E50914] text-[#F9FAFB] rounded-lg px-4 py-2 sm:px-6 text-sm sm:text-base flex items-center justify-center hover:bg-[#F87171] transition">
                        <span class="fa fa-play mr-2"></span>Play Now
                    </button>
                </div>
                <p id="banner-description" class="flex w-full p-1 rounded-md text-xs whitespace-normal sm:text-sm bg-[#1F2937]/50"></p>
            </div>
        </header>
    
        <!-- Movie Rows: Container for all the movie carousels -->
        <main id="movie-rows" class="px-4 md:px-10 pb-16">
            <!-- Rows will be dynamically added here by JavaScript -->
        </main>
    </div>

    <!-- Main Content Area (for search, movies, tv) -->
    <main id="discover-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-8 hidden">
        <!-- Status/Error Message Area (hidden by default) -->
        <div id="status-message" class="hidden bg-[#E50914] p-4 rounded-lg mb-6 text-center text-[#F9FAFB]"></div>

        <!-- Search Results Section (hidden by default) -->
        <section id="search-results-section" class="mb-12 hidden">
            <h2 class="text-3xl font-semibold mb-6 border-b-2 border-[#E50914] pb-2">Search Results</h2>
            <div id="search-results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="search-results-pagination" class="mt-6 flex justify-center"></div>
        </section>

        <!-- Popular Movies Section -->
        <section id="popular-movies-section" class="mb-12">
        <!-- Title -->
        <h2 class="text-3xl font-semibold mb-4 border-b-2 border-[#E50914] pb-2"><span class="vline"></span>Movies</h2>

        <!-- Sort By (Kept as is - assumed to be buttons/tabs) -->
            <div class="mb-4">
                <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Sort By:</label>
                <div id="movie-sort-filters" class="flex gap-2 sort-scroll-container scrollbar-hide"></div>
            </div>

            <!-- Filter Dropdowns Container -->
            <!-- flex-col makes them stack on mobile. sm:flex-row makes them side-by-side from small screens up. -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
        
                <!-- Genre Filter Dropdown Group -->
                <!-- w-full on mobile, w-1/2 from small screens up -->
                <div class="w-full sm:w-1/2">
                    <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Filter by Genre:</label>
                    <!-- The SELECT element is now always visible (removed sm:hidden) -->
                    <select 
                        id="movie-genre-dropdown" class="w-full bg-[#1F2937] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#374151] appearance-none cursor-pointer" onchange="changeGenre('movie', this.value)">
                        <!-- Options will be dynamically populated here -->
                        <option id="movie-genre-filters">All Genres</option>
                    </select>
                </div>

                <!-- Country Filter Dropdown Group -->
                <!-- w-full on mobile, w-1/2 from small screens up -->
                <div class="w-full sm:w-1/2">
                    <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Filter by Country:</label>
                    <!-- The SELECT element is now always visible (removed sm:hidden) -->
                    <select id="movie-country-dropdown" class="w-full bg-[#1F2937] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#374151] appearance-none cursor-pointer" onchange="changeCountry('movie', this.value)">
                    <!-- Options will be dynamically populated here -->
                    <option id="movie-country-filters">All Countries</option>
                    </select>
                </div>
            </div>
            <!-- Movie Content Container (Kept as is) -->
            <div id="popular-movies-container" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="popular-movies-pagination" class="mt-6 flex justify-center"></div>
        </section>


        <!-- Popular TV Shows Section -->
        <section id="popular-tv-section" class="mb-12">
            <!-- Title -->
            <h2 class="text-3xl font-semibold mb-4 border-b-2 border-[#E50914] pb-2"><span class="vline"></span>TV Shows</h2>

            <!-- Sort By (Kept as is - assumed to be buttons/tabs) -->
            <div class="mb-4">
                <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Sort By:</label>
                <div id="tv-sort-filters" class="flex gap-2 sort-scroll-container scrollbar-hide"></div>
            </div>

            <!-- Filter Dropdowns Container -->
            <!-- flex-col makes them stack on mobile. sm:flex-row makes them side-by-side from small screens up. -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <!-- Genre Filter Dropdown Group -->
                <!-- w-full on mobile, w-1/2 from small screens up -->
                <div class="w-full sm:w-1/2">
                    <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Filter by Genre:</label>
                    <!-- The SELECT element is now always visible (removed sm:hidden) -->
                        <select id="tv-genre-dropdown" class="w-full bg-[#1F2937] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#374151] appearance-none cursor-pointer" onchange="changeGenre('tv', this.value)">
                        <!-- Options will be dynamically populated here -->
                        <option id="tv-genre-filters">All Genres</option>
                    </select>
                </div>

                <!-- Country Filter Dropdown Group -->
                <!-- w-full on mobile, w-1/2 from small screens up -->
                <div class="w-full sm:w-1/2">
                    <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Filter by Country:</label>
                    <!-- The SELECT element is now always visible (removed sm:hidden) -->
                    <select 
                        id="tv-country-dropdown" class="w-full bg-[#1F2937] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#374151] appearance-none cursor-pointer" onchange="changeCountry('tv', this.value)">
                        <!-- Options will be dynamically populated here -->
                        <option id="tv-country-filters">All Countries</option>
                    </select>
                </div>
            </div>

            <!-- Movie Content Container (Kept as is) -->
            <div id="popular-tv-container" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="popular-tv-pagination" class="mt-6 flex justify-center"></div>
        </section>


        <!-- Korean TV Shows Section -->
        <section id="korean-tv-section" class="mb-12">
            <!-- Title -->
            <h2 class="text-3xl font-semibold mb-4 border-b-2 border-[#E50914] pb-2"><span class="vline"></span>K-Drama</h2>

            <!-- Sort By (Kept as is - assumed to be buttons/tabs) -->
            <div class="mb-4">
                <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Sort By:</label>
                <div id="korean-tv-sort-filters" class="flex gap-2 sort-scroll-container scrollbar-hide"></div>
            </div>

            <!-- Filter Dropdowns Container -->
            <!-- flex-col makes them stack on mobile. sm:flex-row makes them side-by-side from small screens up. -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
        
                <!-- Genre Filter Dropdown Group -->
                <!-- w-full on mobile, w-1/2 from small screens up -->
                <div class="w-full sm:w-1/2">
                    <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Filter by Genre:</label>
                    <!-- The SELECT element is now always visible (removed sm:hidden) -->
                    <select id="korean-tv-genre-dropdown" class="w-full bg-[#1F2937] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#374151] appearance-none cursor-pointer" onchange="changeGenre('korean-tv', this.value)">
                        <!-- Options will be dynamically populated here -->
                        <option id="korean-tv-genre-filters">All Genres</option>
                    </select>
                </div>
	        </div>

            <!-- Movie Content Container (Kept as is) -->
            <div id="korean-tv-container" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="korean-tv-pagination" class="mt-6 flex justify-center"></div>
        </section>

        <!-- Anime Section -->
        <section id="anime-section" class="mb-12 hidden">
            <h2 class="text-3xl font-semibold mb-4 border-b-2 border-[#E50914] pb-2"><span class="vline"></span>Anime</h2>
            <div class="mb-4">
                <label class="text-[#9CA3AF] text-sm font-semibold block mb-2">Sort By:</label>
                <div id="anime-sort-filters" class="flex gap-2 sort-scroll-container scrollbar-hide"></div>
            </div>
            <div id="anime-container" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="anime-pagination" class="mt-6 flex justify-center"></div>
        </section>
    </main>


    <!-- Details Modal: Pops up when a movie is clicked -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
        <!-- Updated modal background and text colors to be dark -->
        <div id="modal-content" class="relative bg-[#1F2937] text-[#F9FAFB] w-full max-w-5xl rounded-lg shadow-lg overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <!-- Modal content injected here -->
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const API_KEY = '5c7ced332aa33d7507e5d53bd818a963'; 
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/original/';
        const BASE_URL = 'https://api.themoviedb.org/3';

        const STREAM_SOURCES = [
            { url: 'https://vidlink.pro', name: 'VIDLINK' },
            { url: 'https://vidsrcme.su/embed/', name: 'VIDSRC' },
            { url: 'https://vidfast.pro/', name: 'VIDFAST' },
            { url: 'https://mapple.uk/watch', name: 'MAPPLE' },
            { url: 'https://vidrock.net', name: 'VIDROCK' },
            { url: 'https://111movies.com/', name: '1MOVIE' },
            { url: 'https://player.vidplus.to/embed/', name: 'VIDPLUS' }
        ];
        let activeStreamSourceIndex = 0;

        // API endpoints for different movie categories
        const requests = {
            fetchNetflixOriginals: `/discover/tv?api_key=${API_KEY}&with_networks=213`,
            fetchTrending: `/trending/all/week?api_key=${API_KEY}&language=en-US`,
            fetchTopRated: `/movie/top_rated?api_key=${API_KEY}&language=en-US`,
            fetchActionMovies: `/discover/movie?api_key=${API_KEY}&with_genres=28`,
            fetchComedyMovies: `/discover/movie?api_key=${API_KEY}&with_genres=35`,
            fetchHorrorMovies: `/discover/movie?api_key=${API_KEY}&with_genres=27`,
            fetchRomanceMovies: `/discover/movie?api_key=${API_KEY}&with_genres=10749`,
            fetchSciFiMovies: `/discover/movie?api_key=${API_KEY}&with_genres=878`,
            fetchThrillerMovies: `/discover/movie?api_key=${API_KEY}&with_genres=53`,
            fetchAnimationMovies: `/discover/movie?api_key=${API_KEY}&with_genres=16`,
            fetchDocumentaries: `/discover/movie?api_key=${API_KEY}&with_genres=99`,
        };
        
        const GENRES = [
            { id: '', name: 'All Genres' }, { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 10759, name: 'Action & Adventure (TV)' }, { id: 16, name: 'Animation' }, { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' }, { id: 10751, name: 'Family' }, { id: 14, name: 'Fantasy' }, { id: 36, name: 'History' }, { id: 27, name: 'Horror' }, { id: 10402, name: 'Music' }, { id: 9648, name: 'Mystery' }, { id: 10749, name: 'Romance' }, { id: 878, name: 'Science Fiction' }, { id: 10770, name: 'TV Movie' }, { id: 53, name: 'Thriller' }, { id: 10752, name: 'War' }, { id: 37, name: 'Western' },
        ];
        
        const COUNTRIES = [
            { code: '', name: 'All Countries' }, { code: 'US', name: 'United States' }, { code: 'GB', name: 'United Kingdom' }, { code: 'IN', name: 'India (Bollywood)' }, { code: 'KR', name: 'South Korea (K-Drama)' }, { code: 'JP', name: 'Japan' }, { code: 'CA', name: 'Canada' }, { code: 'AU', name: 'Australia' }, { code: 'FR', name: 'France' }, { code: 'DE', name: 'Germany' }, { code: 'ES', name: 'Spain' }, { code: 'MX', name: 'Mexico' }, { code: 'BR', name: 'Brazil' }, { code: 'CN', name: 'China' }, { code: 'IT', 'name': 'Italy' }, { code: 'NL', name: 'Netherlands' }, { code: 'SE', name: 'Sweden' }, { code: 'PL', name: 'Poland' }, { code: 'RU', name: 'Russia' }, { code: 'TR', name: 'Turkey' }, { code: 'HK', name: 'Hong Kong' }, { code: 'IR', name: 'Iran' }, { code: 'ZA', name: 'South Africa' }, { code: 'AR', name: 'Argentina' }, { code: 'DK', name: 'Denmark' }, { code: 'NO', name: 'Norway' }, { code: 'BE', name: 'Belgium' }, { code: 'TH', name: 'Thailand' },
        ];

        // --- DOM ELEMENT SELECTORS ---
        const mainContent = document.getElementById('main-content');
        const discoverContent = document.getElementById('discover-content');
        const movieRowsContainer = document.getElementById('movie-rows');
        const bannerLoading = document.getElementById('banner-loading');
        const popularMoviesContainer = document.getElementById('popular-movies-container');
        const popularTvContainer = document.getElementById('popular-tv-container');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsSection = document.getElementById('search-results-section');
        const popularMoviesSection = document.getElementById('popular-movies-section');
        const popularTvSection = document.getElementById('popular-tv-section');
        const koreanTvSection = document.getElementById('korean-tv-section');
        const animeSection = document.getElementById('anime-section');
        const statusMessage = document.getElementById('status-message');
        const detailModal = document.getElementById('detail-modal');
        const modalContent = document.getElementById('modal-content');
        const searchInputDesktop = document.getElementById('search-input-desktop');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const mobileSearchOverlay = document.getElementById('mobile-search-filter-overlay');
        const desktopNavLinks = document.querySelectorAll('#desktop-nav .nav-link'); 
        
        let currentMediaDetails = null;
        
        const currentPage = { 'movie': 1, 'tv': 1, 'search': 1, 'korean-tv': 1, 'anime': 1 };
        const totalPages = { 'movie': 1, 'tv': 1, 'search': 1, 'korean-tv': 1, 'anime': 1 };
        const currentSort = { 'movie': 'popularity', 'tv': 'popularity', 'korean-tv': 'popularity', 'anime': 'popularity' };
        const currentFilter = { 
            'movie': { genreId: '', countryCode: '' }, 
            'tv': { genreId: '', countryCode: '' },
            'korean-tv': { genreId: '', countryCode: 'KR' },
            'anime': { genreId: '16', countryCode: 'JP' }
        };
        let currentQuery = '';

        // --- CORE FUNCTIONS ---
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3${endpoint}`);
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status} for endpoint: ${endpoint}`);
                    return [];
                }
                const data = await response.json();
                return data.results;
            } catch (error) {
                console.error("Error fetching data:", error);
                return [];
            }
        }
        
        async function fetchApiData(endpoint, queryParams = '', retries = 0) {
            const url = `${BASE_URL}${endpoint}?api_key=${API_KEY}&${queryParams}&include_adult=false&without_keywords=353113|155477|275267|321739|159551|329413|353176`;
            const maxRetries = 3;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchApiData(endpoint, queryParams, retries + 1);
                    }
                    throw new Error(`TMDb API Error: ${response.status} ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                showStatus(`Failed to fetch data: ${error.message}. Please check your API key or network connection.`, 'error');
                return null;
            }
        }

        function truncate(string, n) {
            return string?.length > n ? string.substr(0, n - 1) + '...' : string;
        }

        function createMovieRow(title, movies, isLargeRow = false, rowClasses) {
            if (!movies || movies.length === 0) return;

            const row = document.createElement('div');
            row.className = 'my-8';

            const rowTitle = document.createElement('h2');
            rowTitle.className = 'text-xl md:text-2xl font-bold mb-2 border-b-2 border-[#E50914]';
            rowTitle.textContent = title;
            row.appendChild(rowTitle);

            const rowContainer = document.createElement('div');
            rowContainer.className = 'relative row-container';
            row.appendChild(rowContainer);

            const postersContainer = document.createElement('div');
            postersContainer.className = 'flex overflow-y-hidden overflow-x-scroll p-2 -ml-2 scrollbar-hide';
            rowContainer.appendChild(postersContainer);

            movies.forEach(movie => {
                const imagePath = movie.poster_path; // Always use poster_path
                    if (!imagePath) return;

                const posterWrapper = document.createElement('div');
                const imageWidth = isLargeRow ? '160px' : '128px'; // Adjusted width for normal rows
    
                posterWrapper.className = 'flex-shrink-0 mr-3 text-center cursor-pointer group transition-transform duration-300 hover:scale-105 md:hover:scale-105 shadow-xl';
    
                posterWrapper.style.width = imageWidth;
                posterWrapper.dataset.id = movie.id;
                posterWrapper.dataset.type = movie.media_type || (isLargeRow ? 'tv' : 'movie');
                posterWrapper.addEventListener('click', () => showDetails(posterWrapper.dataset.id, posterWrapper.dataset.type));

                const poster = document.createElement('img');
                poster.src = `${IMAGE_BASE_URL}${imagePath}`;
                poster.alt = movie.name || movie.title;
                poster.loading = 'lazy';
    
                poster.className = `rounded-t-lg object-contain transition-transform duration-300 ${isLargeRow ? 'max-h-60' : 'max-h-48'} mx-auto`;

                const titleElement = document.createElement('p');
                titleElement.textContent = movie.name || movie.title;
    
                /* Updated poster title background and text */
                titleElement.className = 'p-3 text-sm text-[#F9FAFB] truncate bg-[#1F2937]/50 rounded-b-lg duration-300';
    
                titleElement.title = movie.name || movie.title; // Add full title on hover
    
                posterWrapper.appendChild(poster);
                posterWrapper.appendChild(titleElement);
                postersContainer.appendChild(posterWrapper);
            });

            // Add scroll arrows
            const leftArrow = document.createElement('button');
            leftArrow.className = 'scroll-arrow left';
            leftArrow.innerHTML = '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>';
            leftArrow.addEventListener('click', () => {
                postersContainer.scrollBy({ left: -window.innerWidth * 0.8, behavior: 'smooth' });
            });
            rowContainer.appendChild(leftArrow);

            const rightArrow = document.createElement('button');
            rightArrow.className = 'scroll-arrow right';
            rightArrow.innerHTML = '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>';
            rightArrow.addEventListener('click', () => {
                postersContainer.scrollBy({ left: window.innerWidth * 0.8, behavior: 'smooth' });
            });
            rowContainer.appendChild(rightArrow);

            movieRowsContainer.appendChild(row);
        }
        
        function showMainContent() {
            mainContent.classList.remove('hidden');
            discoverContent.classList.add('hidden');
        }
        
        function createLoadingSkeleton() {
            /* Updated skeleton colors */
            return `
                <div class="bg-[#1F2937] rounded-xl overflow-hidden shadow-xl animate-pulse loading-card">
                    <div class="aspect-[2/3] bg-[#374151]"></div>
                    <div class="p-3">
                        <div class="h-4 bg-[#374151] rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-[#374151] rounded w-1/2"></div>
                    </div>
                </div>
            `;
        }

        function renderCards(container, items, mediaType) {
            container.innerHTML = ''; 

            if (!items || items.length === 0) {
                container.innerHTML = `<p class="text-[#9CA3AF] col-span-full text-center py-8">No results found.</p>`;
                return;
            }

            items.forEach(item => {
                const title = item.title || item.name || 'Untitled';
                const releaseDate = item.release_date || item.first_air_date;
                const year = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
                const posterPath = item.poster_path;
                const fullPosterUrl = posterPath ? `https://image.tmdb.org/t/p/w500${posterPath}` : 'https://placehold.co/500x750/1F2937/F9FAFB?text=Poster+Unavailable';
                const cardMediaType = item.media_type || (mediaType === 'movie' ? 'movie' : 'tv');

                const cardHtml = `
                    <div
                        class="poster-card bg-[#1F2937] rounded-xl overflow-hidden shadow-xl"
                        data-id="${item.id}"
                        data-type="${cardMediaType}"
                        onclick="showDetails(this.dataset.id, this.dataset.type)"
                    >
                        <div class="aspect-[2/3] overflow-hidden">
                            <img src="${fullPosterUrl}" alt="${title} poster" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/500x750/1F2937/F9FAFB?text=Poster+Unavailable';" loading="lazy">
                        </div>
                        <div class="p-3 text-center">
                            <p class="text-sm font-medium truncate text-[#F9FAFB]" title="${title}">${title}</p>
                            <p class="text-xs text-[#9CA3AF] mt-0.5">${year}</p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        function renderPagination(container, mediaType, current, total) {
            container.innerHTML = '';
            if (total <= 1) return;

            const createButton = (text, page, isActive = false, isDisabled = false) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.disabled = isDisabled;
                /* Updated pagination button colors */
                button.className = `px-3 py-2 mx-1 rounded-lg font-medium transition duration-200 focus:outline-none ${isActive ? 'bg-[#E50914] text-[#F9FAFB] shadow-md' : 'bg-[#1F2937] text-[#F9FAFB] hover:bg-[#374151] disabled:opacity-50 disabled:cursor-not-allowed'}`;
                
                if (!isDisabled && !isActive) {
                    button.onclick = () => {
                        if (mediaType === 'search') {
                            handleSearch(page, currentQuery); 
                        } else {
                            fetchAndRender(mediaType, page);
                        }
                    };
                }
                return button;
            };
            
            let startPage = Math.max(1, current - 2);
            let endPage = Math.min(total, current + 2);

            if (current <= 3) endPage = Math.min(5, total);
            if (current > total - 3) startPage = Math.max(1, total - 4);

            if (startPage > 1) {
                container.appendChild(createButton('1', 1));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-2 text-[#9CA3AF]';
                    container.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                container.appendChild(createButton(i.toString(), i, i === current));
            }

            if (endPage < total) {
                if (endPage < total - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-2 text-[#9CA3AF]';
                    container.appendChild(ellipsis);
                }
                container.appendChild(createButton(total.toString(), total));
            }
        }
        
        function changeSort(mediaType, sortBy) {
            if (currentSort[mediaType] === sortBy) return;
            currentSort[mediaType] = sortBy;
            currentPage[mediaType] = 1;
            
            const filterContainer = document.getElementById(`${mediaType}-sort-filters`);
            if (filterContainer) {
                filterContainer.querySelectorAll('.sort-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.sort === sortBy);
                });
            }
            fetchAndRender(mediaType, 1);
        }
        
        function changeGenre(mediaType, genreId) {
            const newGenreId = String(genreId); 
            if (currentFilter[mediaType].genreId === newGenreId) return; 
            currentFilter[mediaType].genreId = newGenreId;
            currentPage[mediaType] = 1;
            
            const buttonContainer = document.getElementById(`${mediaType}-genre-filters`);
            if (buttonContainer) {
                buttonContainer.querySelectorAll('.filter-button').forEach(button => {
                   button.classList.toggle('active', button.dataset.value === newGenreId);
                });
            }
            const dropdown = document.getElementById(`${mediaType}-genre-dropdown`);
            if (dropdown) dropdown.value = newGenreId;

            fetchAndRender(mediaType, 1);
        }
        
        function changeCountry(mediaType, countryCode) {
            const newCountryCode = String(countryCode);
            if (currentFilter[mediaType].countryCode === newCountryCode) return;
            currentFilter[mediaType].countryCode = newCountryCode;
            currentPage[mediaType] = 1;
            
            const buttonContainer = document.getElementById(`${mediaType}-country-filters`);
            if (buttonContainer) {
                buttonContainer.querySelectorAll('.filter-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.value === newCountryCode);
                });
            }
            const dropdown = document.getElementById(`${mediaType}-country-dropdown`);
            if (dropdown) dropdown.value = newCountryCode;

            fetchAndRender(mediaType, 1);
        }

        function renderFilterButtons(mediaType, filterType) {
            const containerId = `${mediaType}-${filterType}-filters`;
            const dropdownId = `${mediaType}-${filterType}-dropdown`;
            const container = document.getElementById(containerId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!container || !dropdown) return;

            container.innerHTML = '';
            dropdown.innerHTML = '';
            
            let data, action, currentActive;
            if (filterType === 'genre') {
                data = GENRES; action = `changeGenre('${mediaType}', this.dataset.value)`; currentActive = currentFilter[mediaType].genreId;
            } else if (filterType === 'country') {
                data = COUNTRIES; action = `changeCountry('${mediaType}', this.dataset.value)`; currentActive = currentFilter[mediaType].countryCode;
            } else return;

            data.forEach(item => {
                const value = filterType === 'genre' ? item.id.toString() : item.code;
                const isActive = value === currentActive.toString();
                
                const buttonHtml = `<button class="filter-button ${isActive ? 'active' : ''}" data-type="${mediaType}" data-filter="${filterType}" data-value="${value}" onclick="${action}" title="${filterType === 'country' ? item.code : ''}">${item.name}</button>`;
                container.insertAdjacentHTML('beforeend', buttonHtml);
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = item.name;
                if (isActive) option.selected = true;
                dropdown.appendChild(option);
            });
        }
        
         function renderSortButtons(mediaType) {
            const container = document.getElementById(`${mediaType}-sort-filters`);
            if (!container) return;
            container.innerHTML = `
                <button class="sort-button ${currentSort[mediaType] === 'popularity' ? 'active' : ''}" data-type="${mediaType}" data-sort="popularity" onclick="changeSort('${mediaType}', 'popularity')">Popularity</button>
                <button class="sort-button ${currentSort[mediaType] === 'release_date' ? 'active' : ''}" data-type="${mediaType}" data-sort="release_date" onclick="changeSort('${mediaType}', 'release_date')">New Releases</button>
            `;
        }

        async function fetchAndRender(mediaType, page = 1, query = '') {
            let endpoint = '', containerId, paginationContainerId, queryParams = 'language=en-US';

            if (mediaType === 'movie') {
                endpoint = '/discover/movie'; containerId = 'popular-movies-container'; paginationContainerId = 'popular-movies-pagination';
            } else if (mediaType === 'tv') {
                endpoint = '/discover/tv'; containerId = 'popular-tv-container'; paginationContainerId = 'popular-tv-pagination';
            } else if (mediaType === 'korean-tv') {
                endpoint = '/discover/tv'; containerId = 'korean-tv-container'; paginationContainerId = 'korean-tv-pagination';
            } else if (mediaType === 'anime') {
                endpoint = '/discover/tv'; containerId = 'anime-container'; paginationContainerId = 'anime-pagination';
            } else if (mediaType === 'search') {
                endpoint = '/search/multi'; queryParams += `&query=${encodeURIComponent(query)}`; containerId = 'search-results-container'; paginationContainerId = 'search-results-pagination';
            } else return;
            
            if (mediaType !== 'search') {
                const sortParam = currentSort[mediaType];
                const filter = currentFilter[mediaType];
                const today = new Date().toISOString().split('T')[0];

                if (sortParam === 'popularity') queryParams += '&sort_by=popularity.desc';
                else if (sortParam === 'release_date') {
                    const dateType = mediaType === 'movie' ? 'primary_release_date' : 'first_air_date';
                    queryParams += `&sort_by=${dateType}.desc`;
                    if (mediaType === 'movie') queryParams += `&primary_release_date.lte=${today}`;
                    else if (mediaType === 'tv' || mediaType === 'korean-tv' || mediaType === 'anime') queryParams += `&first_air_date.lte=${today}`;
                }
                if (filter.genreId) queryParams += `&with_genres=${filter.genreId}`;
                if (filter.countryCode) queryParams += `&with_origin_country=${filter.countryCode}`;
            }

            const container = document.getElementById(containerId);
            const paginationContainer = document.getElementById(paginationContainerId);
            
            container.innerHTML = Array(6).fill(createLoadingSkeleton()).join('');
            paginationContainer.innerHTML = '';
            clearStatus();

            queryParams += `&page=${page}`;
            const data = await fetchApiData(endpoint, queryParams);
            
            window.scrollTo(0, 0);

            if (data && data.results) {
                currentPage[mediaType] = data.page;
                totalPages[mediaType] = Math.min(data.total_pages, 500); 

                let itemsToRender = data.results;

                if (mediaType === 'search') {
                    currentQuery = query;
                    itemsToRender = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
                    if (itemsToRender.length === 0) showStatus(`No movies or TV shows found for "${query}" on page ${page}.`, 'info');
                } 
                
                if (itemsToRender.length === 0) container.innerHTML = `<p class="text-[#9CA3AF] col-span-full text-center py-8">No results found for the current sort and filter combination.</p>`;
                else renderCards(container, itemsToRender, mediaType);
                
                if (data.total_results > 0) renderPagination(paginationContainer, mediaType, currentPage[mediaType], totalPages[mediaType]);
            } else container.innerHTML = `<p class="text-center text-[#F9FAFB] col-span-full">Could not load content.</p>`;
        }
        
        function generateStreamUrl(id, type, sourceIndex = activeStreamSourceIndex, season = 1, episode = 1) {
            const baseUrl = STREAM_SOURCES[sourceIndex].url;
            return type === 'movie' ? `${baseUrl}/movie/${id}` : `${baseUrl}/tv/${id}/${season}/${episode}`;
        }

        function switchStreamSource(newSourceIndex) {
            if (newSourceIndex === activeStreamSourceIndex) return;
            activeStreamSourceIndex = newSourceIndex;
            
            document.querySelectorAll('.stream-source-button').forEach((btn, index) => {
                btn.classList.toggle('active-source-button', index === activeStreamSourceIndex);
                btn.classList.toggle('inactive-source-button', index !== activeStreamSourceIndex);
            });

            if (currentMediaDetails) {
                const id = currentMediaDetails.id;
                const type = currentMediaDetails.media_type || (currentMediaDetails.title ? 'movie' : 'tv');
                let season = 1, episode = 1;

                if (type === 'tv') {
                    const seasonSelect = document.getElementById('season-select');
                    const episodeSelect = document.getElementById('episode-select');
                    if (seasonSelect && episodeSelect) {
                         season = parseInt(seasonSelect.value) || 1;
                         episode = parseInt(episodeSelect.value) || 1;
                    }
                }

                const newStreamUrl = generateStreamUrl(id, type, activeStreamSourceIndex, season, episode);
                const iframe = document.getElementById('stream-iframe');
                if (iframe) iframe.src = newStreamUrl;
            }
        }
        
        function updateEpisodeDropdown(seasonsData, selectedSeason, defaultEpisode = 1) {
            const episodeSelect = document.getElementById('episode-select');
            if (!episodeSelect) return;
            episodeSelect.innerHTML = '';
            
            const season = seasonsData.find(s => s.season_number === selectedSeason);
            if (season && season.episode_count > 0) {
                const maxEpisodes = season.episode_count;
                const episodeToSelect = Math.min(maxEpisodes, defaultEpisode); 
                for (let i = 1; i <= maxEpisodes; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `E${i}`;
                    if (i === episodeToSelect) option.selected = true;
                    episodeSelect.appendChild(option);
                }
                episodeSelect.disabled = false;
            } else {
                episodeSelect.innerHTML = '<option value="1">No Episodes</option>';
                episodeSelect.disabled = true;
            }
        }

        function generateTvStreamUrl(id) {
            const seasonSelect = document.getElementById('season-select');
            const episodeSelect = document.getElementById('episode-select');
            const iframe = document.getElementById('stream-iframe');
            if (!seasonSelect || !episodeSelect || !iframe) return;

            const season = parseInt(seasonSelect.value) || 1;
            const episode = parseInt(episodeSelect.value) || 1;
            iframe.src = generateStreamUrl(id, 'tv', activeStreamSourceIndex, season, episode);
        }

        function initializeTvControls(seasonsData, id) {
            const seasonSelect = document.getElementById('season-select');
            const episodeSelect = document.getElementById('episode-select');
            if (!seasonSelect || !episodeSelect) return;

            seasonSelect.innerHTML = '';
            let defaultSeason = 1;

            if (seasonsData.length > 0) {
                const latestValidSeason = seasonsData.filter(s => s.season_number >= 1 && s.episode_count > 0).sort((a, b) => b.season_number - a.season_number)[0];
                defaultSeason = latestValidSeason ? latestValidSeason.season_number : 1;
                seasonsData.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season.season_number;
                    option.textContent = `${season.name} (S${season.season_number})`;
                    if (season.season_number === defaultSeason) option.selected = true;
                    seasonSelect.appendChild(option);
                });
            } else {
                seasonSelect.innerHTML = '<option value="1">Season 1 (Default)</option>';
            }

            updateEpisodeDropdown(seasonsData, defaultSeason, 1);
            generateTvStreamUrl(id);

            seasonSelect.addEventListener('change', () => {
                updateEpisodeDropdown(seasonsData, parseInt(seasonSelect.value), 1);
                generateTvStreamUrl(id);
            });
            episodeSelect.addEventListener('change', () => generateTvStreamUrl(id));
        }

        function openStream(id, type, title) {
            const detailsContainer = document.getElementById('details-metadata-container');
            const playerContainer = document.getElementById('video-player-container');
            const posterColumn = document.getElementById('poster-column');
            
            activeStreamSourceIndex = 0; 
            let streamUrl = '', playerControlsHtml = '', seasonsData = [];
            
            if (type === 'movie') {
                streamUrl = generateStreamUrl(id, 'movie', activeStreamSourceIndex);
            } else if (type === 'tv') {
                if (currentMediaDetails && currentMediaDetails.seasons) {
                    seasonsData = currentMediaDetails.seasons.filter(s => s.season_number >= 1 && s.episode_count > 0);
                }
                streamUrl = generateStreamUrl(id, 'tv', activeStreamSourceIndex);
                /* Updated select dropdown styles */
                playerControlsHtml = `<div class="flex sm:block gap-4 mb-6"><div class="w-1/2 sm:w-full"><label class="text-[#9CA3AF] text-sm font-semibold block mb-2" for="season-select">Season:</label><select id="season-select" class="w-full bg-[#374151] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#4B5563]"></select></div><div class="w-1/2 sm:w-full"><label class="text-[#9CA3AF] text-sm font-semibold block mb-2" for="episode-select">Episode:</label><select id="episode-select" class="w-full bg-[#374151] text-[#F9FAFB] rounded-lg p-2.5 focus:ring-[#E50914] focus:border-[#E50914] border border-[#4B5563]"></select></div></div>`;
            }

            detailsContainer.classList.add('hidden');
            posterColumn.classList.add('hidden'); 
            playerContainer.classList.remove('md:w-2/3', 'hidden');
            playerContainer.classList.add('md:w-full'); 
            
            let sourceSwitcherHtml = `
                <div>
                    <div class="mb-1"><i class="text-[#9CA3AF] text-xs font-bold block mb-1">
                        <span class="fas fa-circle-exclamation"></span> If current server doesn't work please try other servers below:</i>
                    <div class="flex flex-wrap gap-2">${STREAM_SOURCES.map((source, index) => `<button class="stream-source-button transition duration-200 text-xs font-medium ${index === activeStreamSourceIndex ? 'active-source-button' : 'inactive-source-button'}" onclick="switchStreamSource(${index})">${source.name}</button>`).join('')}
                    </div>
                </div>
        </div>`;
            
            /* Updated player header and back button */
            playerContainer.innerHTML = `<div class="flex justify-between items-center mb-4 border-b border-[#374151] pb-2"><h4 class="text-xl font-semibold text-[#F9FAFB]"><span class="vline"></span>${title}</h4><button class="text-[#9CA3AF] hover:text-[#F87171] text-sm font-medium" onclick="showDetails('${id}', '${type}', true)"> Back to Details</button></div>${playerControlsHtml}<div class="aspect-video w-full mb-4 rounded-lg overflow-hidden shadow-2xl"><iframe id="stream-iframe" src="${streamUrl}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay; encrypted-media" referrerpolicy="origin"></iframe></div>${sourceSwitcherHtml}`;
            modalContent.scrollTop = 0;
            
            if (type === 'tv') initializeTvControls(seasonsData, id); 
        }

        async function showDetails(id, type, returningFromStream = false) {
            window.scrollTo(0, 0); 
            let itemDetails = currentMediaDetails;

            if (!returningFromStream || !itemDetails || itemDetails.id != id) {
                /* Updated modal loading spinner */
                modalContent.innerHTML = `<div class="p-8 flex justify-center items-center h-48"><svg class="animate-spin h-8 w-8 text-[#E50914]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="ml-4 text-lg text-[#F9FAFB]">Loading details...</p></div>`;
                detailModal.classList.remove('hidden');
                detailModal.classList.add('flex');
                currentMediaDetails = null;
                itemDetails = await fetchApiData(`/${type}/${id}`, 'language=en-US&append_to_response=credits');
                if (!itemDetails) { modalContent.innerHTML = `<div class="p-6 text-center text-[#F9FAFB]">Failed to load details.</div>`; return; }
                currentMediaDetails = itemDetails;
            } else {
                detailModal.classList.remove('hidden'); detailModal.classList.add('flex');
            }

            const title = itemDetails.title || itemDetails.name || 'Untitled';
            const posterPath = itemDetails.poster_path;
            const fullPosterUrl = posterPath ? `https://image.tmdb.org/t/p/w500${posterPath}` : 'https://placehold.co/500x750/1F2937/F9FAFB?text=Poster+Unavailable';
            const overview = itemDetails.overview || 'No overview available.';
            const tagline = itemDetails.tagline || '';
            const rating = itemDetails.vote_average ? itemDetails.vote_average.toFixed(1) : 'N/A';
            const genres = itemDetails.genres ? itemDetails.genres.map(g => g.name).join(', ') : 'N/A';
            const runtime = itemDetails.runtime ? `${itemDetails.runtime} min` : (itemDetails.episode_run_time ? `${itemDetails.episode_run_time[0]} min (Ep)` : 'N/A');
            const release = itemDetails.release_date || itemDetails.first_air_date || 'N/A';
            const status = itemDetails.status || 'Released';
            const networks = itemDetails.networks ? itemDetails.networks.map(n => n.name).join(', ') : 'N/A';
            const lastAirDate = itemDetails.last_air_date || 'N/A';
            const totalSeasons = itemDetails.number_of_seasons || 'N/A';
            const totalEpisodes = itemDetails.number_of_episodes || 'N/A';
            const displayType = type === 'movie' ? 'Movie' : 'TV Show';
            
            let tvMetadataHtml = '';
            if (type === 'tv') tvMetadataHtml = `<p><span class="text-[#9CA3AF]">Status:</span> ${status}</p><p><span class="text-[#9CA3AF]">Networks:</span> ${networks}</p><p><span class="text-[#9CA3AF]">Seasons:</span> ${totalSeasons}</p><p><span class="text-[#9CA3AF]">Total Episodes:</span> ${totalEpisodes}</p><p><span class="text-[#9CA3AF]">Last Aired:</span> ${lastAirDate}</p>`;
            
            const cast = itemDetails.credits?.cast ? itemDetails.credits.cast.slice(0, 8) : [];
            let castHtml = '';
            if (cast.length > 0) {
                /* Updated cast styles */
                castHtml = `<h4 class="text-xl font-semibold text-[#F9FAFB] mb-4 mt-6 border-b border-[#374151] pb-2">Main Cast</h4><div class="grid grid-cols-4 sm:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-4">${cast.map(member => `<div class="flex flex-col items-center text-center"><img src="${member.profile_path ? `https://image.tmdb.org/t/p/w500${member.profile_path}` : 'https://placehold.co/500x500/1F2937/F9FAFB?text=No+Photo'}" alt="${member.name}" class="w-full h-auto aspect-square object-cover rounded-full border-2 border-[#374151]" onerror="this.onerror=null; this.src='https://placehold.co/500x500/1F2937/F9FAFB?text=No+Photo';" loading="lazy"><p class="text-xs font-medium text-[#F9FAFB] mt-1 truncate w-full" title="${member.name}">${member.name}</p><p class="text-xs text-[#9CA3AF] italic truncate w-full" title="${member.character}">${member.character || 'N/A'}</p></div>`).join('')}</div>`;
            }

            /* Updated modal content styles */
            modalContent.innerHTML = `<div class="p-6"><div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6"><div id="video-player-container" class="w-full hidden md:w-2/3"></div><div id="details-metadata-container" class="w-full md:w-2/3"><h3 class="text-4xl font-bold text-[#F9FAFB] mb-1"><span class="vline"></span>${title}</h3>${tagline ? `<p class="text-[#F87171] italic mb-4 text-lg">${tagline}</p>` : ''}<div class="grid grid-cols-2 gap-y-2 gap-x-4 text-sm mb-6 border-b border-[#374151] pb-4"><p><span class="text-[#9CA3AF]">Type:</span> ${displayType}</p><p><span class="text-[#9CA3AF]">Rating:</span> <span class="font-bold text-[#F9FAFB]"> ${rating}</span> / 10</p><p><span class="text-[#9CA3AF]">Release Date:</span> ${release}</p><p><span class="text-[#9CA3AF]">${type === 'movie' ? 'Runtime:' : 'Episode Time:'}</span> ${runtime}</p>${tvMetadataHtml}<p class="col-span-2"><span class="text-[#9CA3AF]">Genres:</span> ${genres}</p></div><h4 class="text-xl font-semibold text-[#F9FAFB] mb-2">Synopsis</h4><p class="text-[#D1D5DB] leading-relaxed">${overview}</p>${castHtml}</div><div id="poster-column" class="w-full md:w-1/3 flex-shrink-0 order-first md:order-last"><img src="${fullPosterUrl}" alt="${title} poster" class="w-full rounded-lg shadow-xl" onerror="this.onerror=null; this.src='https://placehold.co/500x750/1F2937/F9FAFB?text=Poster+Unavailable';"><button id="watch-button" class="mt-4 w-full bg-[#E50914] hover:bg-[#F87171] text-[#F9FAFB] font-bold py-3 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-[#E50914]" onclick="openStream('${id}', '${type}', '${title.replace(/'/g, "\\'")}')">Watch Now</button></div></div></div><button id="close-details-button" class="absolute top-4 right-4 text-[#9CA3AF] hover:text-[#F87171] transition duration-200" onclick="closeModal()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
        }

        function closeModal(event) {
            if (!event || event.target === detailModal) {
                const streamIframe = document.getElementById('stream-iframe');
                if (streamIframe) streamIframe.src = ''; 
                detailModal.classList.add('hidden');
                detailModal.classList.remove('flex');
                currentMediaDetails = null;
            }
        }
        
        // --- UI/NAVIGATION FUNCTIONS ---
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            const openIcon = document.getElementById('menu-open-icon');
            const closeIcon = document.getElementById('menu-close-icon');

            mobileNav.classList.toggle('-translate-x-full');
            openIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        }

        function toggleMobileSearchOverlay(forceState = null) {
            const isHidden = mobileSearchOverlay.classList.contains('-translate-y-full');
            const newState = forceState !== null ? forceState : isHidden;
            if (newState) {
                mobileSearchOverlay.classList.remove('-translate-y-full');
                if (searchInputMobile) searchInputMobile.focus();
            } else {
                mobileSearchOverlay.classList.add('-translate-y-full');
            }
        }

        function handleSearchDesktop(page = 1) {
            if (searchInputMobile) searchInputMobile.value = searchInputDesktop.value;
            handleSearch(page);
        }

        function handleSearchMobile(page = 1) {
            if (searchInputDesktop) searchInputDesktop.value = searchInputMobile.value;
            toggleMobileSearchOverlay(false);
            handleSearch(page);
        }
        
        async function handleSearch(page = 1) {
            const query = searchInputDesktop.value.trim();
            mainContent.classList.add('hidden');
            discoverContent.classList.remove('hidden');
            window.scrollTo(0, 0); 
            if (query.length < 2) {
                navigateTo('popular-movies-section', 1); 
                if (query.length !== 0) showStatus('Please enter at least 2 characters for search.', 'info');
                return;
            }
            [popularMoviesSection, popularTvSection, koreanTvSection, animeSection].forEach(s => s.classList.add('hidden'));
            searchResultsSection.classList.remove('hidden');
            await fetchAndRender('search', page, query);
        }

        function navigateTo(sectionId, resetPage = 1) {
            mainContent.classList.add('hidden');
            discoverContent.classList.remove('hidden');

            [popularMoviesSection, popularTvSection, searchResultsSection, koreanTvSection, animeSection].forEach(section => {
                if (section) section.classList.add('hidden');
            });
            clearStatus();
            
            if (sectionId !== 'search-results-section') {
                if (searchInputDesktop) searchInputDesktop.value = '';
                if (searchInputMobile) searchInputMobile.value = '';
            }
            
            document.getElementById(sectionId).classList.remove('hidden');
            
            let mediaType;
            if (sectionId === 'popular-movies-section') mediaType = 'movie';
            else if (sectionId === 'popular-tv-section') mediaType = 'tv';
            else if (sectionId === 'korean-tv-section') mediaType = 'korean-tv';
            else if (sectionId === 'anime-section') mediaType = 'anime';
            else if (sectionId === 'search-results-section' && currentQuery) mediaType = 'search';
            
            if (mediaType && currentPage[mediaType] !== resetPage) currentPage[mediaType] = resetPage;

            if (mediaType === 'movie' || mediaType === 'tv' || mediaType === 'korean-tv' || mediaType === 'anime') {
                if (mediaType === 'movie' || mediaType === 'tv') {
                    renderFilterButtons(mediaType, 'country');
                }
                if (mediaType !== 'anime') { // Anime genre is fixed
                    renderFilterButtons(mediaType, 'genre');
                }
                renderSortButtons(mediaType);
                fetchAndRender(mediaType, currentPage[mediaType]);
            } else if (mediaType === 'search') handleSearch(currentPage['search']);

            desktopNavLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.sectionId === sectionId);
            });
        }
        
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-[#E50914]'); // Remove all type classes
            statusMessage.classList.add(type === 'error' ? 'bg-[#E50914]' : 'bg-[#E50914]'); // Use red for both
        }

        function clearStatus() {
            statusMessage.classList.add('hidden');
            statusMessage.textContent = '';
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            bannerLoading.classList.remove('hidden');

            const bannerMovies = await fetchData(requests.fetchNetflixOriginals);
            if (bannerMovies.length > 0) {
                const bannerMovie = bannerMovies[Math.floor(Math.random() * bannerMovies.length)];
                document.getElementById('banner').style.backgroundImage = `url('${IMAGE_BASE_URL}${bannerMovie.backdrop_path}')`;
                document.getElementById('banner-title').textContent = bannerMovie.name || bannerMovie.title || bannerMovie.original_name;
                document.getElementById('banner-description').textContent = truncate(bannerMovie.overview, 150);

                const showBannerModal = async () => {
                    showDetails(bannerMovie.id, 'tv');
                };
                document.getElementById('banner-play-btn')?.addEventListener('click', showBannerModal);
                // document.getElementById('banner-info-btn')?.addEventListener('click', showBannerModal); // This button was removed in the HTML
            } else {
                console.error("Could not load banner movie data.");
            }
            
            bannerLoading.classList.add('hidden');

            const allRows = [
                { title: "Originals", endpoint: requests.fetchNetflixOriginals, isLarge: true },
                { title: "Trending Now", endpoint: requests.fetchTrending },
                { title: "Top Rated", endpoint: requests.fetchTopRated },
                { title: "Action Movies", endpoint: requests.fetchActionMovies },
                { title: "Animation", endpoint: requests.fetchAnimationMovies },
                { title: "Comedy Movies", endpoint: requests.fetchComedyMovies },
                { title: "Horror Movies", endpoint: requests.fetchHorrorMovies },
                { title: "Thriller Movies", endpoint: requests.fetchThrillerMovies },
                { title: "Romance Movies", endpoint: requests.fetchRomanceMovies },
                { title: "Sci-Fi Movies", endpoint: requests.fetchSciFiMovies },
                { title: "Documentaries", endpoint: requests.fetchDocumentaries },
            ];

            Promise.all(allRows.map(row => fetchData(row.endpoint))).then(results => {
                results.forEach((movies, index) => {
                    const rowConfig = allRows[index];
                    createMovieRow(rowConfig.title, movies, rowConfig.isLarge);
                });
            });

            // Set up initial discover views
            renderFilterButtons('movie', 'genre');
            renderFilterButtons('movie', 'country');
            renderFilterButtons('tv', 'genre');
            renderFilterButtons('tv', 'country');
            renderFilterButtons('korean-tv', 'genre');
            renderSortButtons('movie');
            renderSortButtons('tv');
            renderSortButtons('korean-tv');
            renderSortButtons('anime');
        });

        // --- UI EFFECTS ---
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 100) {
                navbar.style.backgroundColor = '#141414'; // Updated scroll color
            } else {
                navbar.style.backgroundColor = 'transparent';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
    const copyrightSpan = document.getElementById('current-year-copyright');
    if (copyrightSpan) {
        const currentYear = new Date().getFullYear();
        
        // Find the text 'GoStream' and replace it with 'YYYY GoStream'
        // This makes the final text: ' YYYY GoStream . All Rights Reserved.'
        copyrightSpan.textContent = copyrightSpan.textContent.replace(
            'GoStream',
            `${currentYear} GoStream`
        );
    }
});

    </script>
</body>

<footer class="rounded-lg shadow-sm m-4 w-full max-w-screen-xl mx-auto p-4 md:py-8">
    
        <div class="pt-3 text-justify text-sm text-[#9CA3AF] sm:text-center">
            <span class="text-[#E50914]">GoStream </span>does not store any files on its server. All contents are provided by non-affiliated third parties.
        </div>
            <hr class="w-100 h-1 mx-auto my-4 bg-[#374151] border-0 rounded-sm md:my-10">
            <p id="credits" class="text-[#F9FAFB]"></p>
            <span id="current-year-copyright" class="block text-sm text-center text-[#9CA3AF] sm:text-center"> GoStream . All Rights Reserved.</span>
        
</footer>


</html>

